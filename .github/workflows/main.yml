name: Fiddler Build & Release Pipeline

on:
  push:
    tags:
      - v*
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  build-and-package:
    name: Build, Patch and Package
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      # 2. ä¸‹è½½å¹¶ä¿®æ”¹Fiddler
      - name: Download and patch Fiddler
        run: |
          # ä¸‹è½½å®˜æ–¹å®‰è£…åŒ…
          wget -q --show-progress https://downloads.getfiddler.com/mac-arm64/Fiddler%20Everywhere%206.0.0.dmg -O fiddler.dmg
          
          # æŒ‚è½½DMGæ–‡ä»¶
          hdiutil attach fiddler.dmg -mountpoint "/Volumes/fiddler" -nobrowse
          mkdir -p patched-app
          cp -R "/Volumes/fiddler/Fiddler Everywhere.app" patched-app/
          hdiutil detach "/Volumes/fiddler"

          # åº”ç”¨è¡¥ä¸
          cd "patched-app/Fiddler Everywhere.app/Contents/Frameworks"
          rm -f libfiddler.dylib
          wget -q --show-progress https://github.com/project-yui/Yui-patch/releases/download/v1.1.3/yui-fiddler-mac-arm64-v1.1.3.dylib -O libfiddler.dylib
          chmod +x libfiddler.dylib

          # ä¿®æ”¹ä¸»ç¨‹åº
          cd ..
          mv Resources/app/out/main.js Resources/app/out/main.original.js
          cat ../../../server/index.js > Resources/app/out/main.js
          cat Resources/app/out/main.original.js >> Resources/app/out/main.js
          cp -R ../../../server/file Resources/app/out

      # 3. åˆ›å»ºZIPåŒ…
      - name: Create compressed package
        run: |
          cd patched-app
          zip -r ../fiddler-patched.zip "Fiddler Everywhere.app"
          cd ..
          
          # è®¡ç®—æ–‡ä»¶å“ˆå¸Œå’Œå¤§å°
          echo "PACKAGE_NAME=fiddler-patched-$(date +%Y%m%d).zip" >> $GITHUB_ENV
          echo "SHA256=$(shasum -a 256 fiddler-patched.zip | cut -d ' ' -f1)" >> $GITHUB_ENV
          echo "SIZE=$(du -h fiddler-patched.zip | cut -f1)" >> $GITHUB_ENV
          
          # é‡å‘½åæ–‡ä»¶åŒ…å«æ—¥æœŸ
          mv fiddler-patched.zip ${{ env.PACKAGE_NAME }}

      # 4. ä¸Šä¼ äº§ç‰©
      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: ${{ env.PACKAGE_NAME }}
          retention-days: 7

      # 5. åˆ›å»ºRelease (ä»…tagè§¦å‘æ—¶)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PACKAGE_NAME }}
          tag_name: ${{ github.ref }}
          name: "Fiddler Patched ${{ github.ref_name }}"
          body: |
            ### ğŸš€ ç ´è§£ç‰ˆ Fiddler Everywhere
            
            **ç‰ˆæœ¬ä¿¡æ¯**  
            - åŸºç¡€ç‰ˆæœ¬: 6.0.0  
            - è¡¥ä¸ç‰ˆæœ¬: v1.1.3  
            - å‘å¸ƒæ—¥æœŸ: $(date +'%Y-%m-%d')  
            
            **æ–‡ä»¶ä¿¡æ¯**  
            - æ–‡ä»¶å: ${{ env.PACKAGE_NAME }}  
            - å¤§å°: ${{ env.SIZE }}  
            - SHA256: `${{ env.SHA256 }}`  
            
            **å…è´£å£°æ˜**  
            > æœ¬ç‰ˆæœ¬ä»…ä¾›å­¦ä¹ æµ‹è¯•ä½¿ç”¨ï¼Œè¯·äºä¸‹è½½å24å°æ—¶å†…åˆ é™¤ã€‚  
            > å®˜æ–¹æ­£ç‰ˆè¯·è®¿é—®: [Telerik Fiddler](https://www.telerik.com/fiddler)
          draft: false
          prerelease: false

      # 6. è¾“å‡ºä¸‹è½½ä¿¡æ¯
      - name: Output download info
        run: |
          echo "=== ä¸‹è½½ä¿¡æ¯ ==="
          echo "ä¸´æ—¶ä¸‹è½½ (7å¤©å†…æœ‰æ•ˆ):"
          echo "https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "æ°¸ä¹…ä¸‹è½½é“¾æ¥:"
            echo "https://github.com/$GITHUB_REPOSITORY/releases/download/${GITHUB_REF#refs/tags/}/${{ env.PACKAGE_NAME }}"
          fi
