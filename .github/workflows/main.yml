name: Build and Package Fiddler

on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ main ]

jobs:
  package-fiddler:
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 16.x

    - name: Download and patch Fiddler
      run: |
        # 1. 下载官方Fiddler
        wget https://downloads.getfiddler.com/mac-arm64/Fiddler%20Everywhere%206.0.0.dmg -O fiddler.dmg
        
        # 2. 挂载DMG并复制文件
        hdiutil attach fiddler.dmg -mountpoint /Volumes/fiddler -nobrowse
        mkdir -p fiddler-app
        cp -R /Volumes/fiddler/Fiddler\ Everywhere.app fiddler-app/
        hdiutil detach /Volumes/fiddler

        # 3. 应用补丁
        cd fiddler-app/Fiddler\ Everywhere.app/Contents
        rm Frameworks/libfiddler.dylib
        wget https://example.com/patches/libfiddler-patched.dylib -O Frameworks/libfiddler.dylib
        
        # 4. 修改主程序
        mv Resources/app/out/main.js Resources/app/out/main.original.js
        cat << 'EOF' > Resources/app/out/main.js
        // 自定义破解代码
        require('./main.original.js');
        EOF

    - name: Zip modified app
      run: |
        cd fiddler-app
        zip -r ../fiddler-patched.zip "Fiddler Everywhere.app"
        cd ..
        echo "ZIP_SIZE=$(du -h fiddler-patched.zip | cut -f1)" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: fiddler-patched
        path: fiddler-patched.zip

    - name: Create release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        files: fiddler-patched.zip
        generate_release_notes: true
        body: |
          ### 破解版 Fiddler Everywhere
          - 版本: 6.0.0
          - 平台: macOS ARM64
          - 文件大小: ${{ env.ZIP_SIZE }}
